<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced Buffalo Slot Game</title>
<style>
  /* Reset and base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    background: #0a0a0a;
    color: #d0f0c0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    user-select: none;
  }
  header {
    background: #062206;
    padding: 15px 20px;
    text-align: center;
    font-weight: 700;
    font-size: 28px;
    letter-spacing: 2px;
    color: #9ef69e;
    text-shadow: 0 0 10px #3e8e3e;
  }
  main {
    flex: 1;
    max-width: 760px;
    margin: 20px auto;
    background: #122612;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 40px #3ea53e;
  }
  #reels {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
  }
  .reel {
    width: 80px;
    height: 240px;
    background: #030;
    border: 3px solid #080;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: inset 0 0 15px #050;
    position: relative;
  }
  .symbols {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    transition: top 1.2s cubic-bezier(0.33, 1, 0.68, 1);
  }
  .symbol {
    height: 80px;
    font-size: 70px;
    line-height: 80px;
    text-align: center;
    user-select: none;
  }
  .symbol.highlight {
    text-shadow:
      0 0 8px #bfff00,
      0 0 15px #bfff00,
      0 0 25px #bfff00,
      0 0 40px #bfff00;
  }
  #controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
  }
  button, select {
    background: #073007;
    border: 2px solid #0b520b;
    border-radius: 10px;
    color: #b9efb9;
    font-size: 18px;
    padding: 10px 18px;
    cursor: pointer;
    box-shadow: 0 0 6px #0b520b;
    user-select: none;
    transition: background 0.3s ease;
  }
  button:hover, select:hover {
    background: #0a860a;
    box-shadow: 0 0 10px #0fdb0f;
  }
  button:disabled {
    background: #033003;
    box-shadow: none;
    cursor: not-allowed;
    color: #555;
  }
  #info {
    font-size: 18px;
    margin-bottom: 15px;
    text-align: center;
    letter-spacing: 0.6px;
  }
  #message {
    font-size: 22px;
    text-align: center;
    min-height: 30px;
    margin-bottom: 20px;
    color: #aaffaa;
    font-weight: 700;
    text-shadow: 0 0 4px #0b540b;
  }
  #payoutModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }
  #payoutContent {
    background: #0b350b;
    border-radius: 12px;
    padding: 25px 30px;
    width: 320px;
    box-shadow: 0 0 30px #12a512;
    color: #d2f7d2;
  }
  #payoutContent h2 {
    margin-top: 0;
    text-align: center;
    font-size: 24px;
    text-shadow: 0 0 5px #43c843;
  }
  #payoutContent ul {
    list-style: none;
    padding-left: 0;
  }
  #payoutContent li {
    padding: 6px 0;
    font-size: 18px;
    border-bottom: 1px solid #27a12744;
  }
  #payoutCloseBtn {
    margin-top: 15px;
    display: block;
    margin-left: auto;
    margin-right: auto;
    padding: 8px 22px;
    background: #0f8f0f;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 0 8px #40db40;
  }
  #payoutCloseBtn:hover {
    background: #17bb17;
  }
  footer {
    text-align: center;
    font-size: 14px;
    padding: 12px;
    color: #555;
    user-select: none;
  }
  @media (max-width: 600px) {
    #reels {
      justify-content: center;
      gap: 10px;
    }
    .reel {
      width: 60px;
      height: 180px;
    }
    .symbol {
      font-size: 50px;
      height: 60px;
      line-height: 60px;
    }
    button, select {
      font-size: 16px;
      padding: 8px 14px;
    }
  }
</style>
</head>
<body>

<header>ü¶¨ Advanced Buffalo Slot ü¶¨</header>

<main>
  <div id="info">
    Credits: <span id="credits">1000</span> | Bet: <span id="bet">10</span> | Wins: <span id="totalWins">0</span> | Spins: <span id="totalSpins">0</span> | RTP: <span id="rtp">0.00%</span>
  </div>

  <div id="reels">
    <div class="reel"><div class="symbols"></div></div>
    <div class="reel"><div class="symbols"></div></div>
    <div class="reel"><div class="symbols"></div></div>
    <div class="reel"><div class="symbols"></div></div>
    <div class="reel"><div class="symbols"></div></div>
  </div>

  <div id="message"></div>

  <div id="controls">
    <button id="spinBtn">Spin</button>
    <button id="autoSpinBtn">Auto Spin: OFF</button>

    <select id="betSelect" aria-label="Select Bet">
      <option value="10">Bet: 10</option>
      <option value="20">Bet: 20</option>
      <option value="50">Bet: 50</option>
      <option value="100">Bet: 100</option>
      <option value="200">Bet: 200</option>
      <option value="max">Max Bet</option>
    </select>

    <button id="soundToggleBtn">Sound: ON</button>
    <button id="payoutBtn">Show Payouts</button>
  </div>
</main>

<!-- Payout Modal -->
<div id="payoutModal" role="dialog" aria-modal="true" aria-labelledby="payoutTitle">
  <div id="payoutContent">
    <h2 id="payoutTitle">Payout Table</h2>
    <ul>
      <li>ü¶¨ Buffalo: 3x = 50, 4x = 200, 5x = 1000</li>
      <li>üêÖ Tiger: 3x = 30, 4x = 150, 5x = 750</li>
      <li>ü¶Ö Eagle: 3x = 20, 4x = 100, 5x = 500</li>
      <li>ü¶å Deer: 3x = 15, 4x = 75, 5x = 250</li>
      <li>üçÄ Clover (Wild): substitutes all</li>
      <li>üçé Apple: 3x = 8, 4x = 40, 5x = 150</li>
      <li>üîî Bell: 3x = 5, 4x = 25, 5x = 100</li>
      <li>‚≠ê Star: 3x = 2, 4x = 10, 5x = 50</li>
    </ul>
    <button id="payoutCloseBtn">Close</button>
  </div>
</div>

<!-- Sounds -->
<audio id="soundSpin" src="https://freesound.org/data/previews/341/341695_6245708-lq.mp3" preload="auto"></audio>
<audio id="soundReelStop" src="https://freesound.org/data/previews/41/41544_512123-lq.mp3" preload="auto"></audio>
<audio id="soundWin" src="https://freesound.org/data/previews/320/320655_5260875-lq.mp3" preload="auto"></audio>
<audio id="bgMusic" src="https://cdn.pixabay.com/download/audio/2022/03/26/audio_f2b8e92d13.mp3?filename=retro-game-loop-11036.mp3" preload="auto" loop></audio>

<script>
(() => {
  const SYMBOLS = [
    { symbol: 'ü¶¨', weight: 20 },
    { symbol: 'üêÖ', weight: 25 },
    { symbol: 'ü¶Ö', weight: 30 },
    { symbol: 'ü¶å', weight: 50 },
    { symbol: 'üçÄ', weight: 70 }, // wild
    { symbol: 'üçé', weight: 80 },
    { symbol: 'üîî', weight: 90 },
    { symbol: '‚≠ê', weight: 100 }
  ];

  const PAYLINES = [
    [1,1,1,1,1],
    [0,0,0,0,0],
    [2,2,2,2,2],
    [0,1,2,1,0],
    [2,1,0,1,2],
    [0,0,1,0,0],
    [2,2,1,2,2],
    [1,0,0,0,1],
    [1,2,2,2,1],
    [0,1,1,1,2]
  ];

  const PAYOUTS = {
    'ü¶¨': [50, 200, 1000],
    'üêÖ': [30, 150, 750],
    'ü¶Ö': [20, 100, 500],
    'ü¶å': [15, 75, 250],
    'üçÄ': [10, 50, 200], // Wild can payout too
    'üçé': [8, 40, 150],
    'üîî': [5, 25, 100],
    '‚≠ê': [2, 10, 50]
  };

  let credits = 1000;
  let bet = 10;
  let totalWins = 0;
  let totalSpins = 0;
  let soundEnabled = true;
  let autoSpin = false;
  let autoSpinInterval = null;

  const reelsEls = [...document.querySelectorAll('.reel .symbols')];
  const creditsEl = document.getElementById('credits');
  const betSelect = document.getElementById('betSelect');
  const spinBtn = document.getElementById('spinBtn');
  const autoSpinBtn = document.getElementById('autoSpinBtn');
  const soundToggleBtn = document.getElementById('soundToggleBtn');
  const messageEl = document.getElementById('message');
  const totalWinsEl = document.getElementById('totalWins');
  const totalSpinsEl = document.getElementById('totalSpins');
  const rtpEl = document.getElementById('rtp');
  const payoutBtn = document.getElementById('payoutBtn');
  const payoutModal = document.getElementById('payoutModal');
  const payoutCloseBtn = document.getElementById('payoutCloseBtn');

  const soundSpin = document.getElementById('soundSpin');
  const soundReelStop = document.getElementById('soundReelStop');
  const soundWin = document.getElementById('soundWin');
  const bgMusic = document.getElementById('bgMusic');

  function weightedRandomSymbol() {
    let totalWeight = SYMBOLS.reduce((sum, s) => sum + s.weight, 0);
    let rand = Math.random() * totalWeight;
    for(let i = 0; i < SYMBOLS.length; i++) {
      if(rand < SYMBOLS[i].weight) return SYMBOLS[i].symbol;
      rand -= SYMBOLS[i].weight;
    }
    return SYMBOLS[SYMBOLS.length -1].symbol;
  }

  function generateReelSymbols() {
    return [weightedRandomSymbol(), weightedRandomSymbol(), weightedRandomSymbol()];
  }

  function generateSpinResult() {
    return Array.from({length: 5}, () => generateReelSymbols());
  }

  function playSound(sound) {
    if(soundEnabled && sound) {
      sound.currentTime = 0;
      sound.play();
    }
  }

  async function animateReels(finalResult) {
    for(let i=0; i<reelsEls.length; i++) {
      const reel = reelsEls[i];
      const symbols = finalResult[i];
      const extendedSymbols = [symbols[2], ...symbols, symbols[0]];
      reel.innerHTML = '';
      extendedSymbols.forEach(sym => {
        const span = document.createElement('div');
        span.className = 'symbol';
        span.textContent = sym;
        reel.appendChild(span);
      });

      reel.style.transition = 'none';
      reel.style.top = '-80px';
    }

    for(let i=0; i<reelsEls.length; i++) {
      const reel = reelsEls[i];
      void reel.offsetWidth;
      reel.style.transition = 'top 1.2s cubic-bezier(0.33, 1, 0.68, 1)';
      reel.style.top = '-240px';

      playSound(soundReelStop);
      await new Promise(r => setTimeout(r, 1300));
    }
  }

  function matchSymbolsOnPayline(result, payline) {
    let firstSymbol = result[0][payline[0]];
    if(firstSymbol === 'üçÄ') {
      for(let r=1; r<5; r++) {
        if(result[r][payline[r]] !== 'üçÄ') {
          firstSymbol = result[r][payline[r]];
          break;
        }
      }
    }
    if(!firstSymbol) return 0;

    let matchCount = 0;
    for(let r=0; r<5; r++) {
      const symbol = result[r][payline[r]];
      if(symbol === firstSymbol || symbol === 'üçÄ') {
        matchCount++;
      } else {
        break;
      }
    }
    return matchCount;
  }

  function calculateWin(result) {
    let totalWin = 0;
    let winningLines = [];

    for(let i=0; i < PAYLINES.length; i++) {
      const payline = PAYLINES[i];
      const matches = matchSymbolsOnPayline(result, payline);
      if(matches >= 3) {
        let baseSymbol = result[0][payline[0]];
        if(baseSymbol === 'üçÄ') {
          for(let r=1; r<5; r++) {
            if(result[r][payline[r]] !== 'üçÄ') {
              baseSymbol = result[r][payline[r]];
              break;
            }
          }
        }
        if(baseSymbol && PAYOUTS[baseSymbol]) {
          const lineWin = PAYOUTS[baseSymbol][matches - 3] * bet;
          totalWin += lineWin;
          winningLines.push({lineIndex: i, symbols: baseSymbol, count: matches, lineWin});
        }
      }
    }
    return {totalWin, winningLines};
  }

  function highlightWinningLines(result, winningLines) {
    reelsEls.forEach(reel => {
      [...reel.children].forEach(symEl => symEl.classList.remove('highlight'));
    });
    winningLines.forEach(winLine => {
      const payline = PAYLINES[winLine.lineIndex];
      for(let r=0; r < winLine.count; r++) {
        const row = payline[r];
        const reel = reelsEls[r];
        // middle symbol is index 1 because of extension
        const symbolIndex = row + 1;
        const symbolEl = reel.children[symbolIndex];
        if(symbolEl) symbolEl.classList.add('highlight');
      }
    });
  }

  function updateStats(winAmount) {
    totalSpins++;
    totalSpinsEl.textContent = totalSpins;
    if(winAmount > 0) {
      totalWins += winAmount;
      totalWinsEl.textContent = totalWins;
    }
    const rtp = totalWins / (totalSpins * bet) * 100 || 0;
    rtpEl.textContent = rtp.toFixed(2) + '%';
  }

  function updateCredits(amount) {
    credits += amount;
    creditsEl.textContent = credits;
  }

  function resetMessage() {
    messageEl.textContent = '';
  }

  async function spin() {
  if (credits < bet) {
    messageEl.textContent = "Not enough credits to spin!";
    spinBtn.disabled = true;
    return;
  }

  resetMessage();
  spinBtn.disabled = true;
  betSelect.disabled = true;
  autoSpinBtn.disabled = true;

  updateCredits(-bet);

  playSound(soundSpin);

  // Generate spin result
  const result = generateSpinResult();

  // Animate reels
  await animateReels(result);

  // Calculate win
  const { totalWin, winningLines } = calculateWin(result);

  if (totalWin > 0) {
    highlightWinningLines(result, winningLines);
    messageEl.textContent = `You won ${totalWin} credits! üéâ`;
    playSound(soundWin);
  } else {
    messageEl.textContent = "No win this time, try again!";
  }

  updateCredits(totalWin);
  updateStats(totalWin);

  spinBtn.disabled = false;
  betSelect.disabled = false;
  autoSpinBtn.disabled = false;

  // If credits run out after spin
  if (credits < bet) {
    messageEl.textContent += " Not enough credits to continue.";
    spinBtn.disabled = true;
    autoSpinBtn.disabled = true;
  }
}

// Auto spin toggler
autoSpinBtn.addEventListener('click', () => {
  if (autoSpin) {
    clearInterval(autoSpinInterval);
    autoSpin = false;
    autoSpinBtn.textContent = "Auto Spin: OFF";
    spinBtn.disabled = false;
    betSelect.disabled = false;
  } else {
    if (credits < bet) {
      messageEl.textContent = "Not enough credits to start Auto Spin!";
      return;
    }
    autoSpin = true;
    autoSpinBtn.textContent = "Auto Spin: ON";
    spinBtn.disabled = true;
    betSelect.disabled = true;
    autoSpinInterval = setInterval(async () => {
      if (credits < bet) {
        clearInterval(autoSpinInterval);
        autoSpin = false;
        autoSpinBtn.textContent = "Auto Spin: OFF";
        spinBtn.disabled = true;
        betSelect.disabled = true;
        messageEl.textContent = "Auto Spin stopped - no more credits.";
        return;
      }
      await spin();
    }, 3500);
  }
});

// Bet change handler
betSelect.addEventListener('change', () => {
  if (betSelect.value === 'max') {
    bet = credits;
  } else {
    bet = parseInt(betSelect.value, 10);
  }
  if (bet > credits) {
    bet = credits;
  }
  document.getElementById('bet').textContent = bet;
  spinBtn.disabled = credits < bet;
});

// Spin button handler
spinBtn.addEventListener('click', () => {
  spin();
});

// Sound toggle handler
soundToggleBtn.addEventListener('click', () => {
  soundEnabled = !soundEnabled;
  soundToggleBtn.textContent = soundEnabled ? "Sound: ON" : "Sound: OFF";
  if (soundEnabled) {
    bgMusic.play();
  } else {
    bgMusic.pause();
  }
});

// Play bg music by default if allowed
window.addEventListener('load', () => {
  if (soundEnabled) {
    bgMusic.volume = 0.15;
    bgMusic.play().catch(() => {
      // Auto play might be blocked, no worries
    });
  }
});

// Show payout modal
payoutBtn.addEventListener('click', () => {
  payoutModal.style.display = 'flex';
});

// Close payout modal
payoutCloseBtn.addEventListener('click', () => {
  payoutModal.style.display = 'none';
});

// Close modal on outside click
payoutModal.addEventListener('click', (e) => {
  if (e.target === payoutModal) {
    payoutModal.style.display = 'none';
  }
});
})();
